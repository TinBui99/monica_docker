import{r as E,e as x,s as $,v as L,S as k,D as M,c as V,o as c,w as y,h as p,b as h,t as d,u as v,a as R,F as B,j as F,i as W,k as G,d as w,n as H,p as K}from"./app-CapNgXf-.js";import{_ as q}from"./ActionSection-Cf9mlxMW.js";import{_ as N}from"./SecondaryButton-LDZ02WBB.js";import{_ as C}from"./ConfirmsPassword-Pp1Q4xjp.js";import{_ as Y}from"./Button-CeJKJvkU.js";import J from"./RegisterKey-CmFJfcPm.js";import j from"./DeleteKeyModal-BikTBGy_.js";import z from"./UpdateKey-B8dqb_OC.js";import{W as m,i as Q,b as D,t as X,c as P,d as Z,e as A,f as ee}from"./startAuthentication-BTaWR7aw.js";import{K as te}from"./WaitForKey-BYvq9w9Y.js";import"./SectionTitle-yCtI3_Xi.js";import"./PrettyButton-C7IwNjfl.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-jKXsEGte.js";import"./DialogModal-DpvCIBlW.js";import"./Modal-Cq3DqFWU.js";import"./Input-DBW5TJZF.js";import"./InputError-BapgdLlk.js";import"./WebauthnTest-DWVvjNye.js";import"./Label-WzmNYhjC.js";import"./ConfirmationModal-C4kmuD-S.js";import"./DangerButton-C3VCCtYy.js";function ae({error:e,options:s}){const{publicKey:r}=s;if(!r)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(s.signal instanceof AbortSignal)return new m({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(r.authenticatorSelection?.requireResidentKey===!0)return new m({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(s.mediation==="conditional"&&r.authenticatorSelection?.userVerification==="required")return new m({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:e});if(r.authenticatorSelection?.userVerification==="required")return new m({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new m({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new m({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return r.pubKeyCredParams.filter(i=>i.type==="public-key").length===0?new m({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new m({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const o=globalThis.location.hostname;if(Q(o)){if(r.rp.id!==o)return new m({message:`The RP ID "${r.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new m({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(r.user.id.byteLength<1||r.user.id.byteLength>64)return new m({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new m({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}async function se(e){!e.optionsJSON&&e.challenge&&(console.warn("startRegistration() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),e={optionsJSON:e});const{optionsJSON:s,useAutoRegister:r=!1}=e;if(!D())throw new Error("WebAuthn is not supported in this browser");const o={...s,challenge:P(s.challenge),user:{...s.user,id:P(s.user.id)},excludeCredentials:s.excludeCredentials?.map(X)},i={};r&&(i.mediation="conditional"),i.publicKey=o,i.signal=Z.createNewAbortSignal();let l;try{l=await navigator.credentials.create(i)}catch(t){throw ae({error:t,options:i})}if(!l)throw new Error("Registration was not completed");const{id:g,rawId:f,response:u,type:T}=l;let _;typeof u.getTransports=="function"&&(_=u.getTransports());let S;if(typeof u.getPublicKeyAlgorithm=="function")try{S=u.getPublicKeyAlgorithm()}catch(t){I("getPublicKeyAlgorithm()",t)}let b;if(typeof u.getPublicKey=="function")try{const t=u.getPublicKey();t!==null&&(b=A(t))}catch(t){I("getPublicKey()",t)}let O;if(typeof u.getAuthenticatorData=="function")try{O=A(u.getAuthenticatorData())}catch(t){I("getAuthenticatorData()",t)}return{id:g,rawId:A(f),response:{attestationObject:A(u.attestationObject),clientDataJSON:A(u.clientDataJSON),transports:_,publicKeyAlgorithm:S,publicKey:b,authenticatorData:O},type:T,clientExtensionResults:l.getClientExtensionResults(),authenticatorAttachment:ee(l.authenticatorAttachment)}}function I(e,s){console.warn(`The browser extension that intercepted this WebAuthn API call incorrectly implemented ${e}. You should report this error to them.
`,s)}const re={key:0,class:"text-lg font-medium text-gray-900 dark:text-gray-100"},ie={key:1,class:"text-lg font-medium text-gray-900 dark:text-gray-100"},ne={key:2,class:"text-lg font-medium text-gray-900 dark:text-gray-100"},oe={key:3},le={key:4},ue={key:5},ce={key:6,class:"mt-5 space-y-6"},de={key:0,class:"dark:text-gray-400"},me={class:"text-gray-500"},pe={class:"ms-3 w-48"},fe={class:"text-sm text-gray-600 dark:text-gray-400"},he={class:"text-xs text-gray-500"},ye={key:0},ge={class:"ms-3 text-sm"},Re={class:"mt-5 flex items-center"},Be={__name:"WebauthnKeys",props:{webauthnKeys:Array,publicKey:Object},setup(e){const s=e,r=E(!0),o=E(""),i=E(!1),l=x({name:""}),g=E(null),f=E(null),u=$(()=>f.value>0?s.webauthnKeys.find(t=>t.id===f.value).name:"");L(()=>{D()||(r.value=!1,o.value=k()),s.publicKey&&(_(),M().then(()=>b(s.publicKey)))});const T=(t,a)=>{switch(t){case"InvalidStateError":return K("This key is already registered. Itâ€™s not necessary to register it again.");case"NotAllowedError":return K("The operation either timed out or was not allowed.");default:return a}},_=()=>{o.value="",i.value=!0},S=()=>{o.value="",l.clearErrors()},b=t=>{se(t).then(a=>O(a)).catch(a=>{o.value=T(a.name,a.message)})},O=t=>{l.transform(a=>({...a,...t})).post(route("webauthn.store"),{preserveScroll:!0,preserveState:!0,onSuccess:()=>{i.value=!1,l.reset()},onError:a=>{o.value=a.email??a.data.errors.webauthn}})};return(t,a)=>(c(),V(q,null,{title:y(()=>[w(d(t.$t("Security keys")),1)]),description:y(()=>[w(d(t.$t("Add additional security to your account using a security key.")),1)]),content:y(()=>[f.value>0?(c(),p("h3",re,d(t.$t("Update a key.")),1)):i.value?(c(),p("h3",ne,d(t.$t("Register a new key.")),1)):(c(),p("h3",ie,d(t.$t("Use a security key (Webauthn, or FIDO) to increase your account security.")),1)),r.value?i.value?(c(),p("div",le,[h(J,{"error-message":o.value,form:v(l),name:v(l).name,"onUpdate:name":a[0]||(a[0]=n=>v(l).name=n),onStart:S,onStop:a[1]||(a[1]=n=>i.value=!1),onRegister:b},null,8,["error-message","form","name"])])):f.value>0?(c(),p("div",ue,[h(z,{keyid:f.value,"name-update":u.value,onClose:a[2]||(a[2]=n=>f.value=null)},null,8,["keyid","name-update"])])):(c(),p("div",ce,[e.webauthnKeys.length===0?(c(),p("div",de,d(t.$t("No keys registered yet")),1)):(c(!0),p(B,{key:1},F(e.webauthnKeys,n=>(c(),p("div",{key:n.id,class:"mb-2 flex items-center"},[R("div",me,[h(v(te))]),R("div",pe,[R("div",fe,d(n.name),1),R("div",he,[n.last_used!==null?(c(),p("span",ye,d(t.$t("Last used :date",{date:n.last_used})),1)):W("",!0)])]),R("div",ge,[h(N,{class:"pointer text-indigo-400 hover:text-indigo-600",href:"",onClick:G(U=>f.value=n.id,["prevent"])},{default:y(()=>[w(d(t.$t("Update")),1)]),_:2},1032,["onClick"]),h(C,{onConfirmed:U=>g.value=n.id},{default:y(()=>[h(N,{class:H(["pointer ms-2 text-indigo-400 hover:text-indigo-600",{"opacity-25":g.value===n.id}]),href:"",disabled:g.value===n.id},{default:y(()=>[w(d(t.$t("Delete")),1)]),_:2},1032,["class","disabled"])]),_:2},1032,["onConfirmed"])])]))),128)),R("div",Re,[h(C,{onConfirmed:_},{default:y(()=>[h(Y,{type:"button"},{default:y(()=>[w(d(t.$t("Register a new key")),1)]),_:1})]),_:1})])])):(c(),p("div",oe,d(v(k)()),1)),h(j,{keyid:g.value,onClose:a[3]||(a[3]=n=>g.value=null)},null,8,["keyid"])]),_:1}))}};export{Be as default};
